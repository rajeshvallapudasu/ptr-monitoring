<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTR Monitoring Dashboard - FIXED | TGTRANSCO</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #475569;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        .topbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .topbar-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .topbar-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .topbar-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .control-panel {
            background: var(--bg-secondary);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }
        .control-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .btn {
            padding: 0.625rem 1.5rem;
            background: var(--accent-primary);
            border: none;
            color: white;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: var(--border);
        }
        .date-input {
            padding: 0.625rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.875rem;
        }
        .main-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            font-size: 0.875rem;
        }
        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-primary);
            color: var(--text-secondary);
        }
        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: var(--accent-warning);
            color: var(--accent-warning);
        }
        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--accent-danger);
            color: var(--accent-danger);
        }
        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: var(--accent-success);
            color: var(--accent-success);
        }
        .debug-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .debug-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }
        .debug-log {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0.5rem 0;
        }
        .stat-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        .stat-progress {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }
        .stat-progress-bar {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        .stat-progress-bar.normal { background: var(--accent-success); }
        .stat-progress-bar.warning { background: var(--accent-warning); }
        .stat-progress-bar.critical { background: var(--accent-danger); }
        .ptr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 2rem;
        }
        .ptr-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--accent-primary);
        }
        .ptr-card.warning { border-left-color: var(--accent-warning); }
        .ptr-card.critical { border-left-color: var(--accent-danger); }
        .ptr-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .readings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .reading-block {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .reading-time {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .reading-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        .reading-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .reading-number {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        @media (max-width: 768px) {
            .ptr-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Dashboard() {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [readings, setReadings] = useState(null);
            const [loading, setLoading] = useState(false);
            const [apiUrl, setApiUrl] = useState('');
            const [debugLog, setDebugLog] = useState([]);
            const [showDebug, setShowDebug] = useState(true);

            const ptrs = [
                { id: 'ptr1_220', name: 'PTR-1', voltage: '220/132 KV', capacity: 100, rated: 262 },
                { id: 'ptr2_220', name: 'PTR-2', voltage: '220/132 KV', capacity: 100, rated: 262 },
                { id: 'ptr1_132', name: 'PTR-1', voltage: '132/33 KV', capacity: 31.5, rated: 138 },
                { id: 'ptr2_132', name: 'PTR-2', voltage: '132/33 KV', capacity: 31.5, rated: 138 }
            ];

            const timeSlots = ['06:30', '07:00', '07:30', '08:00', '15:30', '16:00', '16:30', '17:00'];

            const log = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
                console.log(logEntry);
                setDebugLog(prev => [...prev, logEntry].slice(-20));
            };

            useEffect(() => {
                const saved = localStorage.getItem('ptr_api_url');
                if (saved) {
                    setApiUrl(saved);
                    log('API URL loaded from storage');
                } else {
                    log('No API URL configured', 'warning');
                }
            }, []);

            useEffect(() => {
                if (apiUrl) {
                    loadData();
                }
            }, [selectedDate, apiUrl]);

            const testApiConnection = async () => {
                if (!apiUrl) {
                    alert('Please configure API URL first');
                    return;
                }

                log('Testing API connection...');
                setLoading(true);

                try {
                    // Test with ?action=test
                    const testUrl = `${apiUrl}?action=test`;
                    log(`Testing URL: ${testUrl}`);

                    const response = await fetch(testUrl);
                    const text = await response.text();
                    
                    log(`Response received: ${text.substring(0, 200)}`);
                    
                    try {
                        const data = JSON.parse(text);
                        if (data.status === 'success') {
                            log('‚úì API Connection Successful!', 'success');
                            alert('‚úì API Connection Successful!\n\nYour Google Apps Script is working correctly.');
                        } else {
                            log(`API returned: ${JSON.stringify(data)}`, 'warning');
                            alert('API responded but with unexpected data. Check debug log.');
                        }
                    } catch (e) {
                        log(`Failed to parse response as JSON: ${e.message}`, 'error');
                        alert('API responded but not with valid JSON. Check debug log.');
                    }
                } catch (error) {
                    log(`‚úó Connection failed: ${error.message}`, 'error');
                    alert(`‚úó Connection Failed!\n\n${error.message}\n\nCheck:\n1. API URL is correct\n2. Script is deployed\n3. "Anyone" has access`);
                } finally {
                    setLoading(false);
                }
            };

            const loadData = async () => {
                if (!apiUrl) {
                    log('Cannot load data: No API URL', 'warning');
                    return;
                }

                log(`Loading data for ${selectedDate}...`);
                setLoading(true);

                try {
                    const url = `${apiUrl}?action=getReadings&date=${selectedDate}`;
                    log(`Fetching: ${url}`);

                    const response = await fetch(url);
                    log(`Response status: ${response.status}`);
                    
                    const text = await response.text();
                    log(`Response text (first 200 chars): ${text.substring(0, 200)}`);

                    const data = JSON.parse(text);
                    log(`Parsed data: ${JSON.stringify(data).substring(0, 200)}`);

                    if (data.status === 'success') {
                        log('‚úì Data loaded successfully');
                        setReadings(data.data);
                        
                        // Count non-zero readings
                        let count = 0;
                        Object.values(data.data).forEach(ptr => {
                            Object.values(ptr).forEach(reading => {
                                if (reading.mw > 0 || reading.amps > 0) count++;
                            });
                        });
                        log(`Found ${count} non-zero readings`);
                    } else {
                        log(`API returned status: ${data.status}`, 'warning');
                    }
                } catch (error) {
                    log(`‚úó Error loading data: ${error.message}`, 'error');
                    console.error('Full error:', error);
                } finally {
                    setLoading(false);
                }
            };

            const saveApiUrl = () => {
                const url = prompt('Enter your Google Apps Script Web App URL:', apiUrl);
                if (url) {
                    const trimmed = url.trim();
                    localStorage.setItem('ptr_api_url', trimmed);
                    setApiUrl(trimmed);
                    log(`API URL saved: ${trimmed.substring(0, 50)}...`);
                    alert('API URL saved! Click "Test API" to verify connection.');
                }
            };

            const getPeakAmps = (ptrId) => {
                if (!readings || !readings[ptrId]) return 0;
                return Math.max(...Object.values(readings[ptrId]).map(r => r.amps || 0));
            };

            const getPeakMW = (ptrId) => {
                if (!readings || !readings[ptrId]) return 0;
                return Math.max(...Object.values(readings[ptrId]).map(r => r.mw || 0));
            };

            const getStatus = (amps, rated) => {
                const pct = (amps / rated) * 100;
                if (pct >= 90) return 'critical';
                if (pct >= 75) return 'warning';
                return 'normal';
            };

            const getLoadingPercent = (amps, rated) => {
                return Math.min(((amps / rated) * 100), 100).toFixed(1);
            };

            if (!apiUrl) {
                return (
                    <div>
                        <div className="topbar">
                            <div className="topbar-content">
                                <div className="topbar-left">
                                    <h1>PTR Monitoring Dashboard</h1>
                                    <div className="topbar-subtitle">TGTRANSCO - Huzurnagar Substation</div>
                                </div>
                            </div>
                        </div>
                        <div className="main-content">
                            <div className="alert warning">
                                <strong>‚ö†Ô∏è API Not Configured</strong><br/>
                                Please configure your Google Apps Script Web App URL to start monitoring.
                            </div>
                            <button onClick={saveApiUrl} className="btn" style={{marginTop: '1rem'}}>
                                Configure API URL
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="topbar">
                        <div className="topbar-content">
                            <div className="topbar-left">
                                <h1>PTR Monitoring Dashboard</h1>
                                <div className="topbar-subtitle">220/132/33 KV Substation - Huzurnagar | TGTRANSCO</div>
                            </div>
                            <div className="status-indicator">
                                <div className="status-dot"></div>
                                <span>Live Monitoring</span>
                            </div>
                        </div>
                    </div>

                    <div className="control-panel">
                        <div className="control-content">
                            <div style={{display: 'flex', gap: '1rem', alignItems: 'center'}}>
                                <label style={{fontSize: '0.875rem', color: 'var(--text-secondary)'}}>Date:</label>
                                <input 
                                    type="date"
                                    className="date-input"
                                    value={selectedDate}
                                    onChange={(e) => setSelectedDate(e.target.value)}
                                />
                                <button className="btn" onClick={loadData} disabled={loading}>
                                    {loading ? 'Loading...' : 'üîÑ Refresh'}
                                </button>
                                <button className="btn btn-secondary" onClick={testApiConnection}>
                                    üîç Test API
                                </button>
                                <button className="btn btn-secondary" onClick={saveApiUrl}>
                                    ‚öôÔ∏è Change API
                                </button>
                                <button className="btn btn-secondary" onClick={() => setShowDebug(!showDebug)}>
                                    {showDebug ? 'Hide' : 'Show'} Debug
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="main-content">
                        {showDebug && (
                            <div className="debug-panel">
                                <div className="debug-title">Debug Log (Last 20 Messages)</div>
                                <div className="debug-log">
                                    {debugLog.length > 0 ? debugLog.join('\n') : 'No log messages yet. Click "Refresh" or "Test API" to generate logs.'}
                                </div>
                            </div>
                        )}

                        {!readings && !loading && (
                            <div className="alert info">
                                <strong>‚ÑπÔ∏è No Data Loaded Yet</strong><br/>
                                Click "Refresh" to load data from API, or click "Test API" to verify your connection.
                            </div>
                        )}

                        {readings && (
                            <>
                                <div className="stats-grid">
                                    {ptrs.map(ptr => {
                                        const peakAmps = getPeakAmps(ptr.id);
                                        const peakMW = getPeakMW(ptr.id);
                                        const status = getStatus(peakAmps, ptr.rated);
                                        const loading = getLoadingPercent(peakAmps, ptr.rated);

                                        return (
                                            <div key={ptr.id} className="stat-card">
                                                <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                                                    {ptr.name} ({ptr.voltage})
                                                </div>
                                                <div className="stat-value">{peakAmps.toFixed(1)} A</div>
                                                <div className="stat-subtitle">{peakMW.toFixed(1)} MW Peak</div>
                                                <div className="stat-progress">
                                                    <div className={`stat-progress-bar ${status}`} style={{width: `${loading}%`}}></div>
                                                </div>
                                                <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', display: 'flex', justifyContent: 'space-between'}}>
                                                    <span>{loading}% Loading</span>
                                                    <span>{ptr.rated}A Rated</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                <div style={{fontSize: '1.25rem', fontWeight: '600', marginBottom: '1.5rem', marginTop: '2rem'}}>
                                    Detailed Readings
                                </div>

                                <div className="ptr-grid">
                                    {ptrs.map(ptr => {
                                        const peakAmps = getPeakAmps(ptr.id);
                                        const status = getStatus(peakAmps, ptr.rated);

                                        return (
                                            <div key={ptr.id} className={`ptr-card ${status}`}>
                                                <div className="ptr-title">{ptr.name} - {ptr.voltage}</div>
                                                <div className="readings-grid">
                                                    {timeSlots.map(time => {
                                                        const reading = readings[ptr.id]?.[time] || { mw: 0, amps: 0 };
                                                        const hasData = reading.mw > 0 || reading.amps > 0;

                                                        return (
                                                            <div key={time} className="reading-block">
                                                                <div className="reading-time">{time} HRS</div>
                                                                <div className="reading-value">
                                                                    <span className="reading-label">MW</span>
                                                                    <span className="reading-number" style={{color: hasData ? 'var(--accent-success)' : 'var(--text-muted)'}}>
                                                                        {reading.mw.toFixed(1)}
                                                                    </span>
                                                                </div>
                                                                <div className="reading-value">
                                                                    <span className="reading-label">Amps</span>
                                                                    <span className="reading-number" style={{color: hasData ? 'var(--accent-success)' : 'var(--text-muted)'}}>
                                                                        {reading.amps.toFixed(1)}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
